<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>member_byAjax</title>
<style>
form {
	border: 2px solid green;
}

form>label {
	display: inline-block;
	width: 10%;
	background-color: yellow;
}
</style>
</head>

<body>
	<h1></h1>
	<form action="" name="memberForm">
		<label for="memberNo">회원번호</label>
		<input type="number" name="no" id="memberNo" readonly><br>
		<label for="memberName">회원이름</label>
		<input type="text" name="name" id="memberName"><br>
		<label for="phone">연락처</label>
		<input type="text" name="phone" id="phone"><br>
		<label for="address">주소</label>
		<input type="text" name="addr" id="address"><br>
		<label for="birth">생년월일</label> 
		<input type="date" name="birth" id="birth"><br>
		<label for="image">연락처</label>
		<input type="file" name="image" id="image"><br>
		<input type="submit" value="삽입">
		<input type="reset"	value="초기화">
		<input type="button" value="선택삭제">
	</form>
	<br>

	<div id="show">
		<table border="1">
			<thead>
				<tr>
					<th>회원번호</th>
					<th>회원이름</th>
					<th>연락처</th>
					<th>주소</th>
					<th>생년월일</th>
					<th>사진</th>
					<th>삭제</th>
					
				</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
	</div>

	<script>
		let xhtp = new XMLHttpRequest();
		xhtp.open('get', 'MemberServlet'); // xhtp.open('get', member?cmd=select);
		xhtp.send();
		xhtp.onload = function(){
			let parsed = JSON.parse(this.responseText);
			for(let field in parsed){				
			document.querySelector('#show tbody').append(makeTr(parsed[field]));
			}
		}
		// 삽입
	 	document.forms.memberForm.addEventListener('submit', function(e) {
			e.preventDefault();
			console.log(this);
			let No = this.no.value;
			let Nm = this.name.value;
			let Ar = this.address.value;
			let Ph = this.phone.value;
			let Br = this.birth.value;

			xhtp = new XMLHttpRequest();
			xhtp.open('post', 'MemberServlet'); // 요청방식이 포스트: 매개값이 몸체에 담겨 넘어감
			xhtp.setRequestHeader('Content-type',
					'application/x-www-form-urlencoded'); // 넘어가는 데이터의 타입을 지정해 줘야
			xhtp.send(`name=${Nm}&addr=${Ar}&phone=${Ph}&birth=${Br}&cmd=add`);
			xhtp.onload = function() {
				let parseData = JSON.parse(this.responseText);
				document.querySelector('#show tbody').append(makeTr(parseData));
			}

		})
	 
		let fields = ['membNo', 'membName', 'membPhone', 'membAddr', 'membBirth', 'membImage'];
		function makeTr(member){
			let tr = document.createElement('tr');
			fields.forEach(field =>{
				let td = document.createElement('td');
				//
				td.innerHTML = member[field]? member[field] : (!''? field == 'membImage' ? 'no img' : '' : '');
				tr.append(td);
			});
			
			let btn = document.createElement('button');
			btn.innerHTML = '삭제';
			let td = document.createElement('td');
			td.append(btn);
			tr.append(td);
			
			btn.addEventListener('click', rowDelete, false); // bubble, capture
			return tr;
		}
		
		// 삭제버튼을 누르면 실행할 콜백함수
		function rowDelete(){
			// console.log(this.parentElement.parentElement) 
			// this: btn
			// this.parentElement: td
			// this.parentElement.parentElement: tr
			let delNo = this.parentElement.parentElement.getAttribute('id');
			
			let delAjax = new XMLHttpRequest();
			delAjax.open('post','member');
			delAjax.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
			delAjax.send(`cmd=remove&no=${delNo}`);
			delAjax.onload = function(){
					let result = JSON.parse(delAjax.responseText);
					if(result.retCode == 'Success'){
						document.getElementById(delNo).remove()
					} else {
						alert('처리중 에러 발생!')
					}
			}
		}
 
	</script>

</body>
</html>